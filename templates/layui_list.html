<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
<!--  <title>layuiè§„åˆ™ç®¡ç†</title>-->
  <title>è§„åˆ™ç®¡æ§</title>
  <meta name="description" content="ä¸ä¼šå†™å‰ç«¯åªå¥½ç”¨layui">
  <meta name="author" content="é“é•¿"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="/static/img/logo.png" type="image/x-icon">
  <link rel="stylesheet" href="/static/plugin/layui/css/layui.css">
  <script src="/static/js/jquery.min.js"></script>
  <script src="/static/js/grey.js"></script>
  <script src="/static/plugin/layui/layui.js"></script>
</head>
<body>

<table class="layui-hide" id="test" lay-filter="test"></table>

<script type="text/html" id="toolbarDemo">
  <div class="layui-btn-container">
    <button class="layui-btn layui-btn-sm layui-bg-blue" id="moreTest">
      å¤šé€‰æ“ä½œ
      <i class="layui-icon layui-icon-down layui-font-12"></i>
    </button>
    <button class="layui-btn layui-btn-sm" lay-event="getCheckData">è·å–é€‰ä¸­è¡Œæ•°æ®</button>
    <button class="layui-btn layui-btn-sm" lay-event="getData">è·å–å½“å‰é¡µæ•°æ®</button>
    <button class="layui-btn layui-btn-sm" lay-event="isAll">æ˜¯å¦å…¨é€‰</button>
    <button class="layui-btn layui-btn-sm" id="reloadTest">
      é‡è½½æµ‹è¯•
      <i class="layui-icon layui-icon-down layui-font-12"></i>
    </button>
    <button class="layui-btn layui-btn-sm layui-btn-primary" lay-event="multi-row">
      å¤šè¡Œ
    </button>
    <button class="layui-btn layui-btn-sm layui-btn-primary" lay-event="default-row">
      å•è¡Œ
    </button>
    <button class="layui-btn layui-btn-sm layui-btn-primary" lay-event="jxs">
      è§£æç®¡ç†
    </button>

  </div>
</script>

<script type="text/html" id="cityTpl">
  <select id="demoCity1" class="layui-border" lay-ignore>
    <option value="æµ™æ±Ÿæ­å·">æµ™æ±Ÿæ­å·</option>
    <option value="æ±Ÿè¥¿å—æ˜Œ">æ±Ÿè¥¿å—æ˜Œ</option>
    <option value="æ¹–åŒ—æ­¦æ±‰">æ¹–åŒ—æ­¦æ±‰</option>
  </select>
</script>

<script type="text/html" id="barDemo">
<!--  <a class="layui-btn layui-btn-xs" lay-event="edit">ç¼–è¾‘</a>-->
  <a class="layui-btn layui-btn-xs" lay-event="set_top">é¡¶</a>
  <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="set_bottom">åº•</a>
  <a class="layui-btn layui-btn-xs layui-btn-info" lay-event="set_order">è¾“</a>

<!--  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">éšè—</a>-->
</script>




<script>
layui.use(['table', 'dropdown'], function(){
  var table = layui.table;
  var dropdown = layui.dropdown;
  var $ = layui.$;
  var form = layui.form;
  layer.msg('æœ¬é¡µé¢å±•ç¤ºæ•°æ®ä¸ºæœªæ¥åŠŸèƒ½ï¼Œ<br>å¯èƒ½å¹¶æ²¡æœ‰å®é™…ä½œç”¨,ç­‰é“é•¿å¼ƒå‘åç»­æœ‰ç¼˜äººè¡¥ä¸Šã€‚', {
    closeBtn: 1,
    icon: 6,
    time: 21*1000,
    offset: '21px'
  });

  function setState(data,to_set_state){
    if(data.length < 1){
      return layer.msg('è¯·è‡³å°‘é€‰æ‹©ä¸€è¡Œ');
    }
    to_set_state = to_set_state||0;
    console.log(data);
    let site_names = data.map(it=>it.site_name);
    let site_names_str = site_names.join(',');
    console.log('å‡†å¤‡å°†'+site_names_str+'çš„æ˜¾ç¤ºçŠ¶æ€è®¾ç½®ä¸º:'+to_set_state);
    let params = {"names":site_names_str};
    console.log(params);
    $.post("/admin/rule_state/"+to_set_state,params,function(data,status){
               console.log(data);
               if(data.code === 200){
                   // alert(data.msg);
                  // location.reload();
                 table.reload('test', {
                    // page: {
                    //     curr: 3 //é‡æ–°ä»ç¬¬ 1 é¡µå¼€å§‹
                    // }
                });
               }else{
                   console.log('ä¿®æ”¹å¤±è´¥äº†...');
                   return false
               }
       });
  }

  function setOrder(data,to_set_order){
    if(data.length < 1){
      return layer.msg('è¯·è‡³å°‘é€‰æ‹©ä¸€è¡Œ');
    }
    to_set_order = to_set_order||0;
    console.log(data);
    let site_names = data.map(it=>it.site_name);
    let site_names_str = site_names.join(',');
    console.log('å‡†å¤‡å°†'+site_names_str+'çš„æ˜¾ç¤ºçŠ¶æ€è®¾ç½®ä¸º:'+to_set_order);
    let params = {"names":site_names_str};
    console.log(params);
    $.post("/admin/rule_order/"+to_set_order,params,function(data,status){
               console.log(data);
               if(data.code === 200){
                   // alert(data.msg);
                  // location.reload();
                 table.reload('test', {
                    // page: {
                    //     curr: 3 //é‡æ–°ä»ç¬¬ 1 é¡µå¼€å§‹
                    // }
                });
                 layer.msg('å·²è®¾ç½®é¡ºåºä¸º'+to_set_order,{time:1000});
               }else{
                   console.log('ä¿®æ”¹å¤±è´¥äº†...');
                   return false
               }
       });
  }

  // åˆ›å»ºæ¸²æŸ“å®ä¾‹
  table.render({
    elem: '#test'
    ,url: '/layui/api/list' // æ­¤å¤„ä¸ºé™æ€æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€æ¢æˆçœŸå®æ¥å£
    ,toolbar: '#toolbarDemo'
    ,defaultToolbar: ['filter', 'exports', 'print', {
      title: 'å¸®åŠ©'
      ,layEvent: 'LAYTABLE_TIPS'
      ,icon: 'layui-icon-tips'
    }]
    // ,height: 'full-200' // æœ€å¤§é«˜åº¦å‡å»å…¶ä»–å®¹å™¨å·²å æœ‰çš„é«˜åº¦å·®
    // ,cellMinWidth: 80
    // ,totalRow: true // å¼€å¯åˆè®¡è¡Œ
    ,page: true
    ,limit:12
    ,limits:[10,12,15,20,40,60,80,100,150,200,300,500]
    ,cols: [[
      {type: 'checkbox', fixed: 'left'}
      // ,{field: 'id', fixed: 'left',title: 'ID', width: 20, sort: true,totalRowText: 'åˆè®¡ï¼š'}
      ,{field: 'id',title: 'ID', width: 60, sort: true}
      ,{field: 'site_name', title: 'å­˜å‚¨åç§°', width: 120}
      , {
      field: 'state', title: 'æ˜¾ç¤ºçŠ¶æ€', minWidth: 100, templet: function (res) {
        let menuId = res.site_name;
        if (res.state === 1) {
          return "   <input type='checkbox'  menuId = '" + menuId + "' lay-filter='state' lay-skin='switch' lay-text='æ˜¾ç¤º|å·²éšè—' checked>"
        } else if (res.state === 0) {
          return "   <input type='checkbox'  menuId = '" + menuId + "'  lay-filter='state' lay-skin='switch' lay-text='æ˜¾ç¤º|å·²éšè—'>"
        }
      }
    }
      ,{field: 'order', title: 'é¡ºåº', width: 80}
      ,{field: 'name', title: 'æ˜¾ç¤ºåç§°', width: 120}
      ,{field: 'key', title: 'å”¯ä¸€æ ‡è¯†', width: 120}
      ,{field: 'type', title: '<i class="layui-icon layui-icon-email">ç±»å‹</i>', minWidth: 80}
      ,{field: 'searchable', title: 'å¯æœç´¢', minWidth: 80}
      ,{field: 'quickSearch', title: 'å¯å¿«æœ', minWidth: 80}
      ,{field: 'filterable', title: 'å¯ç­›é€‰', minWidth: 80}

      // ,{field:'city', width:115, title: 'åŸå¸‚', minWidth:115, templet: '#cityTpl', exportTemplet: function(d, obj){
      //   //console.log(obj)
      //   // å¤„ç†è¯¥å­—æ®µçš„å¯¼å‡ºæ•°æ®
      //   var td = obj.td(this.field); //è·å–å½“å‰ td
      //   return td.find('select').val();
      // }}
      ,{fixed: 'right', title:'æ“ä½œ', width: 135, minWidth: 135, toolbar: '#barDemo'}
    ]]
    ,done: function(){
      var id = this.id;

      // é‡è½½æµ‹è¯•
      dropdown.render({
        elem: '#reloadTest' //å¯ç»‘å®šåœ¨ä»»æ„å…ƒç´ ä¸­ï¼Œæ­¤å¤„ä»¥ä¸Šè¿°æŒ‰é’®ä¸ºä¾‹
        ,data: [{
          id: 'reload',
          title: 'é‡è½½'
        },{
          id: 'reload-deep',
          title: 'é‡è½½ - å‚æ•°å åŠ '
        },{
          id: 'reloadData',
          title: 'ä»…é‡è½½æ•°æ®'
        },{
          id: 'reloadData-deep',
          title: 'ä»…é‡è½½æ•°æ® - å‚æ•°å åŠ '
        }]
        // èœå•è¢«ç‚¹å‡»çš„äº‹ä»¶
        ,click: function(obj){
          switch(obj.id){
            case 'reload':
              // é‡è½½ - é»˜è®¤ï¼ˆå‚æ•°é‡ç½®ï¼‰
              table.reload('test', {
                where: {
                  abc: '123456'
                  //,test: 'æ–°çš„ test2'
                  //,token: 'æ–°çš„ token2'
                }
              });
            break;
            case 'reload-deep':
              // é‡è½½ - æ·±åº¦ï¼ˆå‚æ•°å åŠ ï¼‰
              table.reload('test', {
                where: {
                  abc: 123
                  ,test: 'æ–°çš„ test1'
                }
                //,defaultToolbar: ['print'] // é‡è½½å¤´éƒ¨å·¥å…·æ å³ä¾§å›¾æ ‡
                //,cols: ins1.config.cols
              }, true);
            break;
            case 'reloadData':
              // æ•°æ®é‡è½½ - å‚æ•°é‡ç½®
              table.reloadData('test', {
                where: {
                  abc: '123456'
                  //,test: 'æ–°çš„ test2'
                  //,token: 'æ–°çš„ token2'
                }
                ,scrollPos: 'fixed'  // ä¿æŒæ»šåŠ¨æ¡ä½ç½®ä¸å˜ - v2.7.3 æ–°å¢
                ,height: 2000 // æµ‹è¯•æ— æ•ˆå‚æ•°ï¼ˆå³ä¸æ•°æ®æ— å…³çš„å‚æ•°è®¾ç½®æ— æ•ˆï¼Œæ­¤å¤„ä»¥ height è®¾ç½®æ— æ•ˆä¸ºä¾‹ï¼‰
                //,url: '404'
                //,page: {curr: 1, limit: 30} // é‡æ–°æŒ‡å‘åˆ†é¡µ
              });
            break;
            case 'reloadData-deep':
              // æ•°æ®é‡è½½ - å‚æ•°å åŠ 
              table.reloadData('test', {
                where: {
                  abc: 123
                  ,test: 'æ–°çš„ test1'
                }
              }, true);
            break;
          }
          layer.msg('å¯è§‚å¯Ÿ Network è¯·æ±‚å‚æ•°çš„å˜åŒ–');
        }
      });

      // æ›´å¤šæµ‹è¯•
      dropdown.render({
        elem: '#moreTest' //å¯ç»‘å®šåœ¨ä»»æ„å…ƒç´ ä¸­ï¼Œæ­¤å¤„ä»¥ä¸Šè¿°æŒ‰é’®ä¸ºä¾‹
        ,data: [{
          id: 'show',
          title: 'ğŸŸ¢æ˜¾ç¤º'
        },{
          id: 'hide',
          title: 'ğŸ”´éšè—'
        },
          {
            id:'set_top',
            title: 'â¬†ï¸ç½®é¡¶',
          },
          {
            id:'set_order_number',
            title: 'â†•ï¸æŒ‡å®šåºå·',
          },
          {
            id:'set_bottom',
            title: 'â¬‡ï¸ç½®åº•',
          },
        //   {
        //   id: 'add',
        //   title: 'æ·»åŠ '
        // },{
        //   id: 'update',
        //   title: 'ç¼–è¾‘'
        // },{
        //   id: 'delete',
        //   title: 'åˆ é™¤'
        // }
        ]
        //èœå•è¢«ç‚¹å‡»çš„äº‹ä»¶
        ,click: function(obj){
          var checkStatus = table.checkStatus(id)
          var data = checkStatus.data; // è·å–é€‰ä¸­çš„æ•°æ®
          switch(obj.id){
            case 'show':
              // console.log(obj);
              setState(data,1)
              break;
            case 'hide':
              // console.log(obj);
              setState(data,0);
              break;
            case 'set_top':
              // console.log(obj);
              setOrder(data,0);
              break;
            case 'set_order_number':
              layer.prompt({
                  formType: 0,
                  value: '',
                  title: 'è¯·è¾“å…¥æŒ‡å®šçš„æ’åºåºå·,æ•°å­—è¶Šå°æ’åè¶Šé å‰',
                  btn: ['ç¡®å®š','å–æ¶ˆ'], //æŒ‰é’®ï¼Œ
                  btnAlign: 'c'
              }, function(value,index){
                  console.log('value:'+value);
                  var reg = /^[\d]+$/;
                  if(!reg.test(value)){
                    layer.msg('è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—!',{time:500});
                  }else{
                    setOrder(data,Number(value));
                    layer.close(index);
                  }
              });
              // setOrder(data,0);
              break;
            case 'set_bottom':
              // console.log(obj);
              setOrder(data,9999)
              break;
            case 'add':
              layer.open({
                title: 'æ·»åŠ ',
                type: 1,
                area: ['80%','80%'],
                content: '<div style="padding: 16px;">è‡ªå®šä¹‰è¡¨å•å…ƒç´ </div>'
              });
            break;
            case 'update':
              if(data.length !== 1) return layer.msg('è¯·é€‰æ‹©ä¸€è¡Œ');
              layer.open({
                title: 'ç¼–è¾‘',
                type: 1,
                area: ['80%','80%'],
                content: '<div style="padding: 16px;">è‡ªå®šä¹‰è¡¨å•å…ƒç´ </div>'
              });
            break;
            case 'delete':
              if(data.length === 0){
                return layer.msg('è¯·é€‰æ‹©ä¸€è¡Œ');
              }
              layer.msg('delete event');
            break;
          }
        }
      });
    }
    ,error: function(res, msg){
      console.log(res, msg)
    }
  });

  // å·¥å…·æ äº‹ä»¶
  table.on('toolbar(test)', function(obj){
    var id = obj.config.id;
    var checkStatus = table.checkStatus(id);
    var othis = lay(this);
    switch(obj.event){
      case 'getCheckData':
        var data = checkStatus.data;
        layer.alert(layui.util.escape(JSON.stringify(data)));
      break;
      case 'getData':
        var getData = table.getData(id);
        console.log(getData);
        layer.alert(layui.util.escape(JSON.stringify(getData)));
      break;
      case 'isAll':
        layer.msg(checkStatus.isAll ? 'å…¨é€‰': 'æœªå…¨é€‰')
      break;
      case 'multi-row':
        table.reload('test', {
          // è®¾ç½®è¡Œæ ·å¼ï¼Œæ­¤å¤„ä»¥è®¾ç½®å¤šè¡Œé«˜åº¦ä¸ºä¾‹ã€‚è‹¥ä¸ºå•è¡Œï¼Œåˆ™æ²¡å¿…è¦è®¾ç½®æ”¹å‚æ•° - æ³¨ï¼šv2.7.0 æ–°å¢
          lineStyle: 'height: 95px;'
        });
        layer.msg('å³é€šè¿‡è®¾ç½® lineStyle å‚æ•°å¯å¼€å¯å¤šè¡Œ');
      break;
      case 'default-row':
        table.reload('test', {
          lineStyle: null // æ¢å¤å•è¡Œ
        });
        layer.msg('å·²è®¾ä¸ºå•è¡Œ');
      break;
      case 'jxs':
        location.href = 'jxs';
        break;
      case 'LAYTABLE_TIPS':
        layer.alert('Table for layui-v'+ layui.v);
      break;
    };
  });

  //è§¦å‘å•å…ƒæ ¼å·¥å…·äº‹ä»¶
  table.on('tool(test)', function(obj){ // åŒå‡» toolDouble
    var data = obj.data;
    //console.log(obj)
    function setPos(od,msg){
      let obj_name;
      try{
        obj_name = obj.data.api.match(/rule=(.*)/)[1].split('&')[0];
      }catch (e){
        obj_name = obj.data.key;
      }
      console.log(obj);
      let params = {"names":[obj_name].join(',')};
      console.log(params);
      $.post("/admin/rule_order/"+od,params,function(res,status){
           console.log(res);
           if(res.code === 200){
             data.order = od;
             // console.log(obj);
             obj.update({
                  order: data.order
              });
             layer.msg('å·²'+msg);
           }else{
               console.log('ä¿®æ”¹å¤±è´¥äº†...');
               layer.msg(msg+'å¤±è´¥,å…·ä½“é”™è¯¯çœ‹æ—¥å¿—');
               return false
           }
     });
    }
    if(obj.event === 'del'){
      let obj_name;
      try{
        obj_name = obj.data.api.match(/rule=(.*)/)[1].split('&')[0];
      }catch (e){
        obj_name = obj.data.key;
      }
      layer.confirm('çœŸçš„è¦éšè—è§„åˆ™'+obj_name+'ä¹ˆ', function(index){
        console.log(obj);
        let params = {"names":[obj_name].join(',')};
        console.log(params);
        $.post("/admin/rule_state/0",params,function(res,status){
                   console.log(res);
                   if(res.code === 200){
                     data.state = 0;
                     obj.update({
                          // è¿™é‡Œçš„å­—æ®µå¿…é¡»è¦åœ¨ table.render.cols.filed æœ‰å®šä¹‰ï¼Œå¦åˆ™æ— æ³•è§¦å‘è¡¨æ ¼æ¸²æŸ“
                          // key å†³å®šæ˜¯å¦é‡æ–°æ¸²æŸ“æŸä¸€åˆ—ï¼Œvalue ç”± templet é‡Œçš„è¯­å¥è¿›è¡Œé€»è¾‘å¤„ç†
                          state: data.state
                      });
                     // $('input[menuid="'+obj_name+'"]').removeAttr('checked');
                     // table.render();
                       // alert(data.msg);
                      // location.reload();
                   }else{
                       // alert(data.msg);
                       console.log('ä¿®æ”¹å¤±è´¥äº†...');
                       return false
                   }
           });

        // obj.del(); //è¿™æ˜¯åˆ é™¤,éšè—è§„åˆ™æ˜¯ä¸éœ€è¦åˆ é™¤è§„åˆ™çš„,æœ€å¤šä¹Ÿå°±åˆ·æ–°ä¸€ä¸‹
        layer.close(index);
      });
    } else if(obj.event === 'edit'){
      layer.open({
        title: 'ç¼–è¾‘',
        type: 1,
        area: ['80%','80%'],
        content: '<div style="padding: 16px;">è‡ªå®šä¹‰è¡¨å•å…ƒç´ </div>'
      });
    }else if(obj.event === 'set_top'){
      setPos(0,'ç½®é¡¶');
    }else if(obj.event === 'set_bottom'){
      setPos(9999,'ç½®åº•');
    }else if(obj.event === 'set_order'){
      layer.prompt({
                  formType: 0,
                  value: '',
                  title: 'è¯·è¾“å…¥æŒ‡å®šçš„æ’åºåºå·,æ•°å­—è¶Šå°æ’åè¶Šé å‰',
                  btn: ['ç¡®å®š','å–æ¶ˆ'], //æŒ‰é’®ï¼Œ
                  btnAlign: 'c'
              }, function(value,index){
                  console.log('value:'+value);
                  var reg = /^[\d]+$/;
                  if(!reg.test(value)){
                    layer.msg('è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—!',{time:500});
                  }else{
                    setPos(Number(value),'æŒ‡å®šé¡ºåº');
                    layer.close(index);
                  }
              });
    }
  });

  //è§¦å‘è¡¨æ ¼å¤é€‰æ¡†é€‰æ‹©
  table.on('checkbox(test)', function(obj){
    console.log(obj)
  });

  //è§¦å‘è¡¨æ ¼å•é€‰æ¡†é€‰æ‹©
  table.on('radio(test)', function(obj){
    console.log(obj)
  });

  // è¡Œå•å‡»äº‹ä»¶
  table.on('row(test)', function(obj){
    //console.log(obj);
    //layer.closeAll('tips');
  });
  // è¡ŒåŒå‡»äº‹ä»¶
  table.on('rowDouble(test)', function(obj){
    console.log(obj);
  });

  // å•å…ƒæ ¼ç¼–è¾‘äº‹ä»¶
  table.on('edit(test)', function(obj){
    var field = obj.field //å¾—åˆ°å­—æ®µ
    ,value = obj.value //å¾—åˆ°ä¿®æ”¹åçš„å€¼
    ,data = obj.data; //å¾—åˆ°æ‰€åœ¨è¡Œæ‰€æœ‰é”®å€¼

    var update = {};
    update[field] = value;
    obj.update(update);
  });

  form.on('switch(state)', function (data) {
        let site_name = data.elem.attributes['menuId'].nodeValue;
        let to_set_state = data.elem.checked?1:0;
        console.log('å‡†å¤‡å°†'+site_name+'çš„æ˜¾ç¤ºçŠ¶æ€è®¾ç½®ä¸º:'+to_set_state);
        let params = {"names":[site_name].join(',')};
        console.log(params);
        $.post("/admin/rule_state/"+to_set_state,params,function(data,status){
                   console.log(data);
                   if(data.code === 200){
                       // alert(data.msg);
                      // location.reload();
                   }else{
                       // alert(data.msg);
                       console.log('ä¿®æ”¹å¤±è´¥äº†...');
                       data.elem.checked = !to_set_state;
                       return false
                   }
           });
        // console.log(data.value);          // å¼€å…³valueå€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡data.elem.valueå¾—åˆ°

                    // let menuId = data.elem.attributes['menuId'].nodeValue;
                    //console.log(data.elem);         // å¾—åˆ°checkboxåŸå§‹DOMå¯¹è±¡
                    // console.log(data.othis);        // å¾—åˆ°ç¾åŒ–åçš„DOMå¯¹è±¡
  });
});
</script>

</body>
</html>